import{p as x,V as L,u as me,q as fe,j as he,t as ge}from"./countries.js";import{b as K,a as F,A as _,e as Fe,D as q,g as pe,M as Q,c as ve}from"./estimateShippingMethods.js";import{events as Ie}from"@dropins/tools/event-bus.js";import{r as y,e as te}from"./dispatchApiCall.js";import{useState as B,useEffect as z,useCallback as O,useRef as Ee,useMemo as Ae}from"@dropins/tools/preact-hooks.js";import{classes as H,getFormErrors as Ce,VComponent as w}from"@dropins/tools/lib.js";import{Text as ne,useText as be}from"@dropins/tools/i18n.js";import{Field as W,Input as re,Picker as ke,Skeleton as Re,SkeletonRow as k}from"@dropins/tools/components.js";/* empty css                     */import{jsx as a,Fragment as V,jsxs as P}from"@dropins/tools/preact-jsx-runtime.js";import{forwardRef as Me,useRef as $e,useImperativeHandle as we,useState as Z,useEffect as j}from"@dropins/tools/preact-compat.js";const X={firstname:"given-name",lastname:"family-name",company:"organization",country:"country",region:"address-level1",city:"address-level2",postcode:"postal-code",telephone:"tel",street:"address-line1",email:"email",middlename:"additional-name",prefix:"honorific-prefix",suffix:"honorific-suffix"};function oe(e){return Object.keys(e).length===0&&e.constructor===Object}const Se=e=>e.map(t=>{var r;const n=((r=t==null?void 0:t.id)==null?void 0:r.toString())||t.code;return{text:t.name,value:n}}),Le=e=>e?e.map(t=>({text:t.label,value:t.value})):[];function ye({address:e,addressType:t,availableCountries:n,availableRegions:r,config:s,dismissError:i,errors:o,fields:l,onBlur:d,onChange:g,onInvalid:v,onSelection:I,setAddress:u}){const p=()=>{u(c=>({...c,[F.Region]:"",[F.RegionId]:""})),i(F.Region)},C=c=>{u(b=>({...b,[F.RegionId]:c}))};return l.map(c=>{var R;let b,m=c.frontendInput,A,M=c.isDisabled,S=c.isRequired,f=[],h;if(m===x.Multiline?(h=K(c.code,e),b=K(c.code,o)):(h=e[c.code],b=o[c.code]||""),c.code===F.Country&&(f=Le(n),t===_.SHIPPING?(y.value.country=h,A=E=>{const N=E.target,{value:$}=N;$&&G({country_code:$}),I(E),p()}):A=I),c.code===F.RegionId&&t===_.SHIPPING&&(y.value.selectedRegionId=h),c.code===F.Region){if(t===y.value.addressType&&(M=y.value.pending),S=s.countriesWithRequiredRegion.includes(e==null?void 0:e.country_id),f=Se(r),!S&&!s.displayStateIfOptional&&(m=x.Undefined),m=f.length>0?x.Select:x.Text,m===x.Select)t===_.SHIPPING?(y.value.selectedRegion=h,A=E=>{const $=E.target.value;G({country_code:y.value.country,region_id:$}),I(E),C($)}):A=E=>{I(E);const $=E.target.value;C($)};else if(m===x.Text&&t===_.SHIPPING){y.value.selectedRegion=h;const E=g;g=N=>{const $=N.target,{value:Y}=$;y.value.country&&G({country_code:y.value.country,region_name:Y}),E(N)}}h=f.length>0?((R=f.find(E=>E.value===h))==null?void 0:R.value)||"":h}return c.code===F.PostCode&&(S=!s.countriesWithOptionalZipCode.includes(e==null?void 0:e.country_id)),{...c,error:b,frontendInput:m,handleSelect:A,isDisabled:M,isRequired:S,onBlur:d,onChange:g,onInvalid:v,options:f,value:h}})}let ee;function G(e){var i;const t=te.value.data,n=!!t,r=(i=t==null?void 0:t.shippingAddresses)==null?void 0:i[0],s=r==null?void 0:r.availableShippingMethods;n&&!s&&(clearTimeout(ee),ee=setTimeout(()=>{Fe({cartId:t.id,criteria:e})},q))}const U=({addressType:e,code:t,index:n})=>n?`${e}-${t}-${n}`:`${e}-${t}`,T=e=>`checkout-address-form__${e}`,Ne=({addressType:e,element:t})=>{const{code:n,value:r,defaultValue:s}=t;return a("input",{className:T(n),id:U({addressType:e,code:n}),name:n,type:"hidden",value:r||s},n)},De=({addressType:e,element:t})=>{const{code:n,error:r,isDisabled:s,label:i,onBlur:o,onChange:l,onInvalid:d,validateRules:g,value:v}=t,I=ae(g);return a(W,{disabled:s,error:r,children:a(re,{"aria-label":i,autocomplete:X[n]||"off",className:T(n),floatingLabel:`${i} ${t.isRequired?"*":""}`,id:U({addressType:e,code:n}),onBlur:o,onChange:l,onInvalid:d,placeholder:i,required:t.isRequired||!1,type:"text",name:n,value:v??void 0,...I})})},_e=({addressType:e,element:t})=>{const{code:n,error:r,isDisabled:s,isRequired:i,label:o,multilineCount:l,onBlur:d,onChange:g,onInvalid:v,validateRules:I,value:u}=t,p=l??0,C=ae(I);return a(V,{children:Array.from(Array(p).keys()).map(c=>a(W,{disabled:s,error:(r==null?void 0:r[c])||"",className:"dropin-field--multiline",children:a(re,{id:U({addressType:e,code:n,index:c}),className:T(n),floatingLabel:`${o} ${c!=0?c:""} ${i&&c===0?"*":""}`,autocomplete:c===0?X[n]:"off","aria-label":o,placeholder:`${o} ${c!=0?c:""}`,type:"text",required:i&&c===0,onChange:g,onBlur:d,onInvalid:v,name:`${n}-${c}`,value:(u==null?void 0:u[c])||void 0,...C})},`${n}-${c}`))})},xe=({addressType:e,element:t})=>{const{code:n,error:r,handleSelect:s,isDisabled:i,isRequired:o,label:l,onBlur:d,onInvalid:g,options:v,value:I}=t,u=s?{handleSelect:s}:{};return a(W,{disabled:i,error:r,children:a(ke,{id:U({addressType:e,code:n}),className:T(n),name:n,floatingLabel:`${l} ${o?"*":""}`,required:o,placeholder:l,"aria-label":l,options:v,value:I,autocomplete:X[n]||"off",onBlur:d,onInvalid:g,...u},n)})},ze=({addressType:e,element:t})=>{switch(t.frontendInput){case"BOOLEAN":case"DATE":case"DATETIME":case"FILE":case"GALLERY":case"IMAGE":case"MEDIA_IMAGE":case"MULTISELECT":case"PRICE":case"TEXTAREA":case"UNDEFINED":case"WEIGHT":return null;case"HIDDEN":return Ne({addressType:e,element:t});case"TEXT":return De({addressType:e,element:t});case"MULTILINE":return _e({addressType:e,element:t});case"SELECT":return xe({addressType:e,element:t});default:return null}},ae=e=>e?e.reduce((t,n)=>{switch(n.name){case L.DateRangeMax:return{...t,max:n.value};case L.DateRangeMin:return{...t,min:n.value};case L.FileExtensions:return{...t,accept:n.value};case L.InputValidation:return{...t,pattern:Pe(n.value)};case L.MaxFileSize:case L.MaxImageHeight:case L.MaxImageWidth:return t;case L.MaxTextLength:return{...t,maxLength:n.value};case L.MinTextLength:return{...t,minLength:n.value};default:throw new Error(`Unknown rule: ${n.name}`)}},{}):{},D={alpha:/^[a-zA-Z]+$/,alphanumeric:/^[a-zA-Z0-9]+$/,"alphanumeric-w-space":/^[a-zA-Z0-9 ]+$/,"alphanum-with-spaces":/^[a-zA-Z0-9 ]+$/,email:/^([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*@([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*\.(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]){2,})$/i,numeric:/^[0-9]+$/,url:/^((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=+$,\w]+@)?[A-Za-z0-9.-]+|(?:www\.|[-;:&=+$,\w]+@)[A-Za-z0-9.-]+)((?:\/[+~%/.\w\-_]*)?\??(?:[-+=&;%@.\w_]*)#?(?:[.!/\\\w]*))?)$/},Pe=e=>{switch(e){case"alpha":return D.alpha.source;case"alphanumeric":return D.alphanumeric.source;case"alphanumeric-w-space":return D["alphanumeric-w-space"].source;case"alphanum-with-spaces":return D["alphanum-with-spaces"].source;case"url":return D.url.source;case"numeric":return D.numeric.source;case"email":return D.email.source;default:throw new Error(`Unknown validation type: ${e}`)}},Ve=e=>P(Re,{...e,children:[a(k,{variant:"heading",size:"medium"}),a(k,{variant:"empty",size:"medium"}),a(k,{size:"large"}),a(k,{size:"large"}),a(k,{size:"large",fullWidth:!0}),a(k,{size:"large",fullWidth:!0,lines:3}),a(k,{size:"large"}),a(k,{size:"large"}),a(k,{size:"large"}),a(k,{size:"large"}),a(k,{size:"large"}),a(k,{size:"large"}),a(k,{size:"large"})]}),Oe=({addressType:e,className:t,fields:n,formRef:r,headingId:s,name:i,...o})=>P("div",{...o,className:H(["checkout-fields-form",t]),children:[a(ce,{level:2,children:a(ne,{id:s}),className:"checkout-fields-form__title"}),a("form",{name:i,ref:r,className:H(["checkout-fields-form__form",t]),noValidate:!0,children:n.sort((l,d)=>!l.sortOrder||!d.sortOrder?l.code<d.code?-1:1:l.sortOrder-d.sortOrder).map(l=>ze({element:l,addressType:e}))})]}),Be=e=>{const t=new FormData(e),n=Object.fromEntries(t);return Object.entries(n).reduce((s,[i])=>{const o=e.elements[i];return o!=null&&o.validationMessage?{...s,[i]:o.validationMessage}:{...s}},{})};function Ue(e){const[t,n]=Z({});return j(()=>{e&&n(r=>({...r,country_id:e}))},[e]),{defaultValues:t}}function Te({country:e,addressType:t}){const[n,r]=Z([]);return j(()=>{if(!e){r([]);return}pe(e,t).then(s=>{r(s||[])}).catch(s=>{console.error(s)})},[r,e,t]),{availableRegions:n}}function Ge({shouldAutoFillForm:e,addressType:t,setAddress:n,fields:r}){const[s,i]=Z(!1),o=te.value.data;j(()=>{var b;if(s||!(o&&r))return;i(!0);const d=t===_.SHIPPING?o==null?void 0:o.shippingAddresses:o==null?void 0:o.billingAddress;if(!(Array.isArray(d)?d.length>0:!!d)||e&&!e())return;const I=m=>{if(!r)return!1;const A=r.find(M=>M.code===m);return A?A.frontendInput==="MULTILINE":!1},u=Array.isArray(d)?d[0]:d;if(!u)return;const p={[F.City]:u.city,[F.Company]:u.company||"",[F.Country]:u.country.value,[F.FirstName]:u.firstName,[F.LastName]:u.lastName,[F.PostCode]:u.postCode||"",[F.Telephone]:u.telephone||"",[F.Vat]:u.vatId||""},C=u.region;if(C){const m=(b=C==null?void 0:C.id)==null?void 0:b.toString();m?(p[F.Region]=m,p[F.RegionId]=m):p[F.Region]=C.code}u!=null&&u.street&&u.street.length>0&&u.street.forEach((m,A)=>{p[`${F.Street}${Q}${A}`]=m}),((u==null?void 0:u.customAttributes)||[]).forEach(m=>{I(m.code)?m.value.split(ve).forEach((M,S)=>{p[`${m.code}${Q}${S}`]=M}):p[m.code]=m.value}),n(p)},[n,e,t,o,r,s])}const ft=Me(({name:e,preselectedFields:t,addressType:n,headingId:r,saveAddressHandler:s,children:i,shouldAutoFillForm:o,...l},d)=>{const{fields:g}=me(),{countries:v}=fe(),I=v===void 0,u=g===void 0,{config:p}=he(),C=p===void 0,{defaultValues:c}=Ue(p==null?void 0:p.defaultCountry),{preselection:b}=Je({fields:g,preselectedFields:t}),m=$e(null),{address:A,setAddress:M,onSelection:S,errors:f,dismissError:h,onChange:R,onInvalid:E,onBlur:N}=Xe({formRef:m,type:n,defaultValues:c,preselection:b,saveAddressHandler:s}),{availableRegions:$}=Te({country:A.country_id,addressType:n});if(we(d,()=>({triggerSaveAddress:le=>{if(!m.current)return;const de=Be(m.current);if(oe(de))return s({signal:le,address:A})}})),Ge({shouldAutoFillForm:o,addressType:n,setAddress:M,fields:g}),u||I||C)return a(Ve,{"data-testid":`${n}-skeleton`});const ue=ye({address:A,addressType:n,availableCountries:v,availableRegions:$,config:p,dismissError:h,errors:f,fields:g,onBlur:N,onChange:R,onInvalid:E,onSelection:S,setAddress:M}),J={[_.SHIPPING]:"shipping",[_.BILLING]:"billing"};return a(Oe,{...l,name:e,addressType:n,className:`checkout-${J[n]}-form`,"data-testid":`${J[n]}-form`,fields:ue,formRef:m,headingId:r})});function He(e){const{backupService:t}=ge(),[n,r]=B(null);z(()=>{const o=t.restore(e);o&&r(o)},[e,t]),z(()=>{const o=Ie.on("checkout/order",()=>{t.remove(e)});return()=>{o==null||o.off()}},[e,t]);const s=O(o=>setTimeout(()=>{t.backup(e,o)},q),[e,t]),i=O(()=>{t.remove(e)},[e,t]);return{addressBackup:n,backup:s,removeBackup:i}}const qe={badInput:"aria-label",patternMismatch:"aria-label",rangeOverflow:"max",rangeUnderflow:"min",tooLong:"maxlength",tooShort:"minlength",typeMismatch:"aria-label",valueMissing:"aria-label"},We=["badInput","patternMismatch","rangeOverflow","rangeUnderflow","tooLong","tooShort","typeMismatch","valueMissing"],Ze=e=>{const[t,n]=B({}),r=O(i=>{const{name:o,validity:l,validationMessage:d}=i;let g=l.valid?"":d;We.forEach(v=>{if(!l[v])return;const I=e[v];if(!I)return;const u=qe[v];g=I.replace("{field}",i.getAttribute(u)||"")}),n(v=>({...v,[o]:g}))},[e]);return{errors:t,dismissError:i=>{t[i]&&n(o=>{const{[i]:l,...d}=o;return d})},validateFormElement:r}},je=e=>{const t=e.current;if(!t)return!1;const n=Ce(t);return oe(n)},Xe=({formRef:e,type:t,defaultValues:n={},preselection:r={},saveAddressHandler:s})=>{const i=be({badInput:"Checkout.AddressForm.Validity.badInput",patternMismatch:"Checkout.AddressForm.Validity.patternMismatch",rangeUnderflow:"Checkout.AddressForm.Validity.rangeUnderflow",tooLong:"Checkout.AddressForm.Validity.tooLong",tooShort:"Checkout.AddressForm.Validity.tooShort",typeMismatch:"Checkout.AddressForm.Validity.typeMismatch",valueMissing:"Checkout.AddressForm.Validity.valueMissing"}),o=Ee(!1),[l,d]=B({}),{addressBackup:g,backup:v,removeBackup:I}=He(t),{errors:u,validateFormElement:p,dismissError:C}=Ze(i),c=O(f=>{o.current=!1,s(f).then(()=>{I()}).catch(h=>{o.current=!0,console.error("Saving address form failed:",h)})},[I,s]),b=(f,h)=>{d(R=>({...R,[f]:h})),o.current=!0},m=f=>{const h=f.target,{name:R,value:E}=h;b(R,E),p(h)},A=f=>{const h=f.target;p(h)},M=f=>{const h=f.target,{name:R,value:E}=h;b(R,E),p(h)},S=f=>{f.target.checkValidity()};return z(()=>{d(f=>({...n,...r,...g,...f}))},[n,r,g]),z(()=>{if(!o.current)return;const f=v(l);return()=>{clearTimeout(f)}},[l,v]),z(()=>{if(!o.current||!je(e))return;const f=new AbortController,h=f.signal,R=setTimeout(()=>{c({signal:h,address:l})},q);return()=>{clearTimeout(R),f.abort()}},[l,e,c]),{address:l,setAddress:d,errors:u,dismissError:C,onChange:m,onSelection:M,onBlur:S,onInvalid:A}},Ye={countryCode:F.Country,region:F.Region,postCode:F.PostCode};function Je({fields:e,preselectedFields:t}){return{preselection:Ae(()=>!(!!e&&e.length>0)||!!!t?null:Object.keys(t).reduce((i,o)=>{const l=Ye[o];return!l||!e.some(g=>g.code===l)?i:{...i,[l]:t[o]}},{}),[e,t])}}const Ke=()=>{const e=()=>window.innerWidth>=1920?"xxlarge":window.innerWidth>=1366?"xlarge":window.innerWidth>=1024?"large":window.innerWidth>=768?"medium":"small",[t,n]=B(e());return z(()=>{let r;const s=()=>{r&&clearTimeout(r),r=setTimeout(()=>n(e()),50)};return window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s),r&&clearTimeout(r)}},[]),t},se=({children:e,className:t})=>Ke()==="small"?a(V,{children:e}):a("div",{className:t,children:e}),Qe=({sections:e})=>a(se,{className:"checkout__aside",children:P(V,{children:[a(w,{node:e.orderSummary}),a(w,{node:e.cartSummary})]})}),et=({billingAddress:e,billToShippingAddress:t,login:n,paymentMethods:r,placeOrder:s,shippingAddress:i,shippingMethods:o})=>P(V,{children:[a(w,{node:n}),i&&a(w,{node:i}),t&&a(w,{node:t}),o&&a(w,{node:o}),a(w,{node:r}),a(w,{node:e}),a(w,{node:s})]}),tt=({outOfStock:e,sections:t})=>a(se,{className:"checkout__main",children:P(V,{children:[a(ce,{level:1,className:"checkout-title",children:a(ne,{id:"Checkout.title"})}),e&&a(w,{className:"checkout-outOfStock",node:e}),t&&a(et,{...t})]})}),ie=e=>{const{banner:t,className:n,children:r,...s}=e;return P("div",{className:H(["checkout",n]),...s,children:[t&&a(w,{className:"checkout__banner",node:t}),a("div",{className:"checkout__content",children:r})]})};ie.Main=tt;ie.Aside=Qe;const ce=({className:e,children:t,level:n=2})=>{const r=n>=1&&n<=6?`h${n}`:"h2";return a(r,{className:e,children:t})};export{ft as A,ie as C,ce as H,Ke as u};
//# sourceMappingURL=CartSummaryItem.js.map
